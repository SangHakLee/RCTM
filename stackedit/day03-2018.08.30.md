
## Ansible

### 이미지 생성
```bash
$ virt-builder --size 20G --format raw --root-password password:openstack -o /var/lib/libvirt/images/osp-ansible.qcow2 centos-7.5

$ virt-builder --size 20G --format raw --root-password password:openstack -o /var/lib/libvirt/images/osp-compute.qcow2 centos-7.5

$ virt-builder --size 20G --format raw --root-password password:openstack -o /var/lib/libvirt/images/osp-control.qcow2 centos-7.5
```
- 위의 3개 모두 빈 파일이고 같은 스펙이기 때문에 하나의 이미지를 복사해서 이름만 변경해도 된다.

#### ovs 네트워크 확인
p216
```bash
$ ovs-vsctl show
```
- `qg` - 게이트웨이
- `qr` - 라우터

### 가상 머신 생성 (3개)

1. **[ansible.example.com]**
- mem: 2048
- cpu: 1
- 하드웨추가 - 네트워크 - 가상 네트워크(virtio)
- `$ nmtui`
	- eth0
		`ip` 192.168.122.100/24
		`gateway` 192.168.122.1
		`dns` 8.8.8.8
	- eth1
		`ip` 192.168.90.100/24
		 - [x] never use this network for default route
	- Set system hostname
		ansible.example.com

2. **[control.example.com]**
- mem: 8192
- cpu: 2
- 하드웨추가 - 네트워크 - 가상 네트워크(virtio)
- `$ nmtui`
	- eth0
		`ip` 192.168.122.110/24
		`gateway` 192.168.122.1
		`dns` 8.8.8.8
	- eth1
		`ip` 192.168.90.110/24
		 - [x] never use this network for default route
	- Set system hostname
		control.example.com
	
3. **[compute01.example.com]**
- mem: 8192
- cpu: 2
- 하드웨추가 - 네트워크 - 가상 네트워크(virtio)
- `$ nmtui`
	- eth0
		`ip` 192.168.122.120/24
		`gateway` 192.168.122.1
		`dns` 8.8.8.8
	- eth1
		`ip` 192.168.90.120/24
		 - [x] never use this network for default route
	- Set system hostname
		compute01.example.com

#### 추가 설정
```bash
# ansible.example.com
$ yum install git -y

$ git clone http://git.howtodothat.kr/dustbox/openstack-skt-lecture

$ cat <<EOF>> /etc/hosts
192.168.90.100 ansible.example.com
192.168.90.110 control.example.com
192.168.90.120 compute01.example.com
EOF

$ for i in 100 110 120 ; do scp /etc/hosts root@192.168.90.$i:/etc/hosts ; done # for 문으로 파일 copy
```
- EOF
	![2018-08-30 15-39-57 eof](https://user-images.githubusercontent.com/9030565/44839669-4a757780-ac7a-11e8-8ba8-d607aaa9cc4c.png)
- for
	![2018-08-30 15-45-46 for](https://user-images.githubusercontent.com/9030565/44839709-5cefb100-ac7a-11e8-864e-82b636bd8824.png)

#### hosts 설정 변경
```bash
# ansible.example.com
$ vi /root/openstack-skt-lecture/hosts
```
```bash
[controller]
control.example.com

[compute]
compute01.example.com
```

#### ansible 설치
```bash
# ansible.example.com
$ yum install -y ansible
```

#### ansible 사용 (ssh key)
```bash용
# ansible.example.com
$ ssh-keygen -t rsa -N '' -f /root/.ssh/id_rsa

$ ssh-copy-id root@control.example.com
$ ssh-copy-id root@compute01.example.com
$ ssh-copy-id root@ansible.example.com

$ ansible-playbook -t prepare openstack.yaml # 사전준비
$ ansible-playbook openstack.yaml # 실제 설치
```
- `ssh-copy-id`: password 물어봄


https://ovirt.org/

#### ansible-playbook 오류 처리

![2018-08-30 16-40-35](https://user-images.githubusercontent.com/9030565/44839793-94f6f400-ac7a-11e8-808a-4e1d17009eac.png)

1. /etc/hosts
	```bash
	192.168.90.100 ansible.example.com ansible
	192.168.90.110 control.example.com control
	192.168.90.120 compute01.example.com compute01
	```
	- 뒤에 3차 도메인 값 추가

2. copy hosts
	```bash
	$ for i in 100 110 120 ; do scp /etc/hosts root@192.168.90.$i:/etc/hosts ; done
	``` 

**yum tip**
```bash
$ yum history
$ yum history rollback <ID>
$ yum history undo <ID>
$ yum history redo <ID>
```

#### openstack 명령어
```bash
$ . rc_admin
$ openstack
(openstack) user create --password openstack --email user1@example.com --description "user1" user1

(openstack) project create pro-user1

(openstack) role add --user user1 --project pro-user1 _member_
(openstack) role assignment list --user user1 --names

(openstack) endpoint list --service keystone

(openstack) service list
```

## glance
p103
p104

#### glance 확인
```bash
$ cd /etc/glance
$ grep -E -v '^$|^#' glance-api.conf 
```

#### glance 상태 확인
```bash
~(keystone_admin)]$ openstack-service status glance
```
```bash
MainPID=1190 Id=openstack-glance-api.se인rvice ActiveState=active
MainPID=1296 Id=openstack-glance-registry.service ActiveState=active
```
- `openstack-glance-api.service` -API
- `openstack-glance-registry.service` - 파일 분석, DB 저장

### glance의 문제
p104
> glance의 이미지 파일은 `/var/lib/glance/images`에 저장된다.
> 만약, `$ mv /var/lib/glance/images/* /tmp/` 명령어로 이미지 파일을 전체 이동하면 어떻게 될까?
> 
> `$ openstack image list`로 조회하면 `/var/lib/glance/images/`에 실제로 이미지 파일이 없기 떄문에 나오지 않아야 하지만, 제대로 조회된다.
> glance DB에 저장된 내용을 조회하는 것이기 때문이다.
>
> 따라서, `/var/lib/glance/images` 디렉토리의 실제 이미지 파일을 이동, 삭제해도 openstack은 오류라 판단하지 않는다.
> 
> 실제 오류는 image를 save할 때 오류가 난다. `$ openstack image save --file aa.raw {IMG-ID}`
> 
> glance 이미지 파일이 이동, 삭제 되는 순간에 오픈스택 시스템이 오류라 판단하지 않기 때문에 사용자는 꼭 주의해서 glance 이미지 파일을 관리해야 한다.

### glance 실습
p103 


#### centos 이미지 다운

1. https://www.centos.org/download/
2. DVD http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1804.iso
3. Download http://mirror.kakao.com/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1804.iso

LDAP -> [389DS](http://directory.fedoraproject.org/)

리눅스 boxes 실행

# day03
![2018-08-30 12-07-54 box](https://user-images.githubusercontent.com/9030565/44831116-0c6b5a00-ac60-11e8-8e92-f433d7ab18ce.png)
![2018-08-30 12-17-33](https://user-images.githubusercontent.com/9030565/44831118-0ecdb400-ac60-11e8-929f-fe7ddcb6b0e7.png)
![2018-08-30 12-18-01](https://user-images.githubusercontent.com/9030565/44831127-12f9d180-ac60-11e8-9771-ad5c3a6ea8f9.png)
![2018-08-30 12-18-34](https://user-images.githubusercontent.com/9030565/44831129-155c2b80-ac60-11e8-87ad-d516c67e5c30.png)
![2018-08-30 12-18-47](https://user-images.githubusercontent.com/9030565/44831131-18571c00-ac60-11e8-8ab4-3d7f46572471.png)
![2018-08-30 12-19-04](https://user-images.githubusercontent.com/9030565/44831134-1a20df80-ac60-11e8-8bcc-3bcd6619b6f9.png)
![2018-08-30 12-19-36](https://user-images.githubusercontent.com/9030565/44831138-1c833980-ac60-11e8-83e1-45a1ffce49da.png)
캡처

#### 생성된 box VM 확인
```bash
# host에서 진행
$ cd /home/openstack/.local/share/gnome-boxes/images
$ ll -h
$ qemu-img info centos7.0 
```

#### 이미지 복사
```bash
$ cp centos7.0 /home/openstack/
```

혹은

```bash축
$ ln centos7.0 centos7.0.bak용
$ mv centos7.0.bak ~
```
- cp 명령어가 너무 오래 걸려서 link로 사용

#### 이미지 압축
```bash
$ cd ~

$ virt-sysprep -a centos7.0.bak
$ ll -h centos7.0.bak # 4.6G
트
$ virt-sparsify --compress centos7.0.bak centos7.0.bak.comp
```
- `virt-sysprep`:  초기화
	![2018-08-30 13-46-57 virt-sysprep](https://user-images.githubusercontent.com/9030565/44831171-4c324180-ac60-11e8-9036-34bdc8b02b85.png)
- `virt-sparsify`: 다이어트, 오래 걸림림
	![2018-08-30 14-23-29 virt-sparsify](https://user-images.githubusercontent.com/9030565/44831173-4dfc0500-ac60-11e8-9631-2a1ed7d74092.png)



### 오픈스택 이미지 다운로드
https://docs.openstack.org/image-guide드/obtain-images.html

#### Centos6
- http://cloud.centos.org/centos/6/images/
- http://cloud.centos.org/centos/6/images/CentOS-6-x86_64-GenericCloud.qcow2

#### Centos7
- http://cloud.centos.org/centos/7/images/
- http://cloud.centos.org/centos/7/images/CentOS-7-x86_64-GenericCloud.qcow2

#### Debian
- http://cdimage.debian.org/cdimage/openstack/current/
- http://cdimage.debian.org/cdimage/openstack/current/debian-9.5.2-20180809-openstack-amd64.qcow2

#### Ubuntu
- http://cloud-images.ubuntu.com/xenial/current/
- http://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img

### 이미지 업로드 1 - Dashboard
http://192.168.122.100/dashboard

#### Ubuntu 이미지 생성
![2018-08-30 14-09-36](https://user-images.githubusercontent.com/9030565/44831208-7a178600-ac60-11e8-8054-4b3c76d9bec5.png)

#### Centos7 이미지 생성
![2018-08-30 14-19-26 centos 7](https://user-images.githubusercontent.com/9030565/44831210-7ab01c80-ac60-11e8-9f95-7d4db57e475d.png)


![2018-08-30 14-41-37 2](https://user-images.githubusercontent.com/9030565/44839446-c15e4080-ac79-11e8-8cf6-03451ba79a1c.png)

### 이미지 업로드 2 - console

#### 이미지 복사
```bash
$ cd ~
$ scp debian-9.5.2-20180809-openstack-amd64.qcow2 root@192.168.122.100:/root/
```

**sshpass**: 암호 입력
```bash
$ sudo yum install sshpass -y

$ sshpass -p "openstack" scp debian-9.5.2-20180809-openstack-amd64.qcow2 root@192.168.122.100:/root/
```
<!--stackedit_data:
eyJoaXN0b3J5IjpbNTUyNDM1NzM1LC00MzIwMjQzODMsMTkyMz
IxNjgwNiwtMzUzOTA2MDMwLC0xNzgwNTgyODk5LDExNzA3MDY3
NDcsLTIwMzc5MjM5OTIsLTEwMDUwNjA4ODUsLTc0ODY4ODMxMy
w3OTA0MDAwNTEsMjAyOTcyOTcwNSwyMjU4MTE0NDQsMTMwMTY5
NDI0MSwtMzk1NTY5NTI0LC0xMjc0MDM1MjcxLDEyMzkxOTY5Nz
YsLTUxMjQ0NDM0NywtOTI1NzI1OTE5LDg2NzgxMzAxMiw3NzM4
MTE3OTZdfQ==
-->